language: php
cache:
  apt: true
  directories:
    - $HOME/.composer/cache
env:
  global:
    - COMPOSER_FLAGS='--prefer-stable'
    - CC_TEST_REPORTER_ID=ae72d604c76bbd8cd0d0b8318930e3a28afd007ab8381d2a8c49ce296ca2b292
matrix:
  include:
    - php: 7.2
      env:
        - COMPOSER_FLAGS='--prefer-lowest'
    - php: 7.2
      env:
        - COVERAGE=true
    - php: 7.3
    - php: 7.4
    - php: 7.4
      env:
        - STABILITY='dev'
before_script:
  - |
    if [ "$COVERAGE" = "true" ]; then
      curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./cc-test-reporter
      chmod +x ./cc-test-reporter
      ./cc-test-reporter before-build
    fi
  - if [ "$STABILITY" != "" ]; then travis_retry composer config minimum-stability ${STABILITY}; fi;
  - if [ -f /home/travis/.phpenv/versions/$(phpenv version-name)/etc/conf.d/xdebug.ini ]; then mv /home/travis/.phpenv/versions/$(phpenv version-name)/etc/conf.d/xdebug.ini ~/xdebug.ini; fi;
  - COMPOSER_MEMORY_LIMIT=-1 travis_retry composer update -o --no-interaction ${COMPOSER_FLAGS}
  - if [ -f ~/xdebug.ini ]; then mv ~/xdebug.ini /home/travis/.phpenv/versions/$(phpenv version-name)/etc/conf.d/xdebug.ini; fi;
  - chmod -R 0777 tests/project-s5
script:
  - if [ "$COVERAGE" = "true" ]; then phpdbg -qrr vendor/bin/phpunit --verbose --coverage-text --coverage-clover=coverage.xml; else vendor/bin/phpunit --verbose --no-coverage; fi;
  - if [ "$COVERAGE" = "true" ]; then php tests/checkCoverage.php; fi;
after_script:
  - if [ "$COVERAGE" = "true" ]; then ./cc-test-reporter after-build --exit-code $TRAVIS_TEST_RESULT; fi;
  - if [ "$COVERAGE" = "true" ]; then bash <(curl -s https://codecov.io/bash); fi;
